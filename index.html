<!DOCTYPE html>
<html>
    <head>
		<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
		<!-- <meta name="viewport" content="initial-scale=1.0, user-scalable=yes, width=device-width" /> -->
        <meta charset="utf-8" />
        <title>Vicky Chat</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link id="link" rel="stylesheet" type="text/css" href="css/styleNorm.css">
		<link rel="icon" type="image/png" href="image/logo.png" />
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
    </head>
	
    <body>
		<div id="allDiv" class="hide">
			<div id="overlay" onclick="off()">
				<img id="imageOverlay" class="bigPic" src="">
			</div>
			<!-- <iframe id="my_iframe" style="display:none;"></iframe> -->
			<div id="canv">
				<canvas id="paper" width="5000px" height="5000px">
					Your browser needs to support canvas for this to work!
				</canvas>	
				<div id="cursors">
					<!-- The mouse pointers will be created here -->
				</div>
			</div>
			<div id="all" class="container">
				<div class="row">
					
					<div id="droite" class="col-12 col-md-5 col-lg-4 col-xl-3 order-md-last">
						<div class="rectBord row">
							<div class="col-12">
								<div class="row">
									<div class="col-12">
										<div class="grosTitre">Utilisateurs :</div>
									</div>
								</div>
								<div class="row" id="zone_util">
								
								</div>
							</div>
						</div>
						<div class="rectBord row">
							<div class="col-12">
								<div class="row">
									<div class="col-12">
										<div class="grosTitre">Thèmes :</div>
									</div>
								</div>
							
								<div class="row">
									<div id="allColor" class="col-12">
										<div id="styleNorm" class="style"></div>
										<div id="styleBleu" class="style"></div>
										<div id="styleRouge" class="style"></div>
										<div id="styleVert" class="style"></div>
										<div id="styleHalloween" class="style"></div>
										<div id="styleOrange" class="style"></div>
										<div id="styleRose" class="style"></div>
										<div id="styleMatrix" class="style"></div>
										<div id="styleElisath" class="style"></div>
										<div id="stylePSG" class="style"></div>
										<div id="styleFF7" class="style"></div>
									</div>	
								</div>

								
							</div>
						</div>	
					</div>
					<div id="gauche" class="col-12 col-md-7 col-lg-8 col-xl-9 order-md-first">
						<div id="form" class ="rectBord row">
							<div class="col-12">
								<form action="/" method="post" id="formulaire_chat">
									<div class="row no-gutters">
										<div class="col-auto">
											<img id='avatar' src="">
										</div>
										
										<div class="col">
											<div class="row no-gutters height_avatar">
												<div class="col-12 col-sm-4 colAlignCenter align-self-center">
													<span id="pseudo" class="titre">-</span>
												</div>
												<div class="d-none d-sm-block col-sm-4 colAlignCenter align-self-center">
													<span class="fas fa-arrow-right titre"></span>
												</div>
												<div class="col-12 d-sm-none colAlignCenter align-self-center">
													<span class="fas fa-arrow-down titre"></span>
												</div>
												<div class="col-12 col-sm-4 colAlignCenter align-self-center">
													<select name="combo" id="combo" class="bouton">
														<option value="Tous">Tous</option>
													</select>
												</div>
											</div>
										</div>
				
									</div>
									<div class="row no-gutters">
										<div class="col-12 col-sm">
											<textarea name="message" id="message" placeholder="Votre message... /help pour les commandes" class="saisie"></textarea>
										<!-- </div> -->
										<!-- <div class="col-6 col-sm-3 colAlignCenter"> -->
										</div>
										<div class="col-6 col-sm-auto colAlignCenter">
											<button type="submit" id="envoi_message" class="bouton">Envoyer <i class='fas fa-share-square'></i></button>
										</div>
										<div class="col-6 col-sm-auto colAlignCenter">
											<input id="upload-input" type="file" name="uploads[]" multiple="multiple" />
											<button class="upload-btn bouton" type="button">Upload <i class="fas fa-upload"></i></button>
										</div>
									</div>
									<div class="row no-gutters">
										<div class="col-12">
											<div class="progress">
											  <div class="progress-bar" role="progressbar"></div>
											</div>
										</div>
									</div>
									<div id="zone_client_ecrit" class="row no-gutters">
										<div class="col-12">
											<span>En train d'écrire :</span>
										</div>
									</div>
								</form>
								<div class="col-12 colAlignCenter" style="display:none;"> 
									<button id="bouton_test" class="bouton">Cliquez sur moi :)</button>
								</div>
							</div>
						</div>
						<div id="zone_chat" class ="rectBord row">
								
						</div>
					</div>
				</div>
			</div>
			<div id="top" class="container-fluid backColorTransp">
				<div class="row">
					<div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-sm-4 col-md-3 col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-md-3 col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-lg-2 col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
					<div class="col-xl-1 fas fa-arrow-up titreColor"></div>
				</div>
			</div>
		</div>
		<script>
		//<input type="text" name="message" id="message" placeholder="Votre message..." autofocus />
			/*var d0 = document.getElementById('all');
			var d2 = document.getElementById('droite');
			var d1 = document.getElementById('gauche');
			var d3 = document.getElementById('message');
			var d4 = document.getElementById('envoi_message');*/
			/*var d1width = (parseInt(parseInt(getComputedStyle(d0,null).width,10)*0.75,10) - 60);
			var d2width = (parseInt(parseInt(getComputedStyle(d0,null).width,10)*0.25,10) - 10);
			d1.style.width = d1width+"px";
			d2.style.width = d2width+"px";
			d3.style.width = (d1width - parseInt(d4.offsetWidth,10) - 20)+"px";*/
		</script>
		
		<!-- Insert this line above script imports  -->
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
		
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
		<!-- <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script> -->
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
		<script src="https://unpkg.com/infinite-scroll@3/dist/infinite-scroll.pkgd.min.js"></script>
        <!-- <script src="socket.io/socket.io.js"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.2.1/socket.io.min.js"></script>
		
		<!-- Insert this line after script imports -->
		<script>if (window.module) module = window.module;</script>
		
        <script>
//async function global(){

	var electron = null;
	var ses = null;
	try{
		electron = require('electron');
		var session = electron.remote.session;
		ses = session.fromPartition('persist:name');					
	}catch(error) {
		//console.error(error);
		electron = null;
	}
	
	//const io = require('socket.io-client');
	
	// Connexion à socket.io
	var ip = 'https://vickychat.herokuapp.com';
	//var ip = 'http://192.168.1.74:5000';
	var socket;

	var pseudo = null;
	var url = null;
	var style = null;
	var fluid = null;
	
	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	$('#top').click(function(event) {
		document.body.scrollTop = 0; // For Safari
		document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
	});
	
	//async 
	function globalStyle(styleCss){
		$('link[id="link"]').attr('href','css/style'+styleCss+'.css');
		var color = "style"+styleCss;
		createCookie("style",color,356);
		//ctx.strokeStyle = $(".titre").css("color");
		/*await sleep(10);
		for(var i=0; i<100;i++){
			ctx.strokeStyle = $(".titre").css("color");
			await sleep(10);
			ctx.stroke();
		}*/
	}
	
	$('#styleNorm').click(async function(event) {
		await globalStyle("Norm");
		/*alert(
		'dw '+$(document).width()+'\n'+   // returns height of browser viewport
		'dh '+$(document).height()+'\n'+ // returns height of HTML document
		'ww '+$(window).width()+'\n'+   // returns width of browser viewport
		'wh '+$(window).height() // returns width of HTML document
		);*/
	});
	$('#styleBleu').click(async function(event) {
		await globalStyle("Bleu");
	});
	$('#styleRouge').click(async function(event) {
		await globalStyle("Rouge");
	});
	$('#styleVert').click(async function(event) {
		await globalStyle("Vert");
	});
	$('#styleOrange').click(async function(event) {
		await globalStyle("Orange");
	});
	$('#styleRose').click(async function(event) {
		await globalStyle("Rose");
	});
	$('#styleMatrix').click(async function(event) {
		await globalStyle("Matrix");
	});
	$('#styleElisath').click(async function(event) {
		await globalStyle("Elisath");
	});
	$('#styleFF7').click(async function(event) {
		await globalStyle("FF7");
	});
	$('#stylePSG').click(async function(event) {
		await globalStyle("PSG");
	});
	$('#styleHalloween').click(async function(event) {
		await globalStyle("Halloween");
	});

	$('#message').keydown(function(event) {
		if (event.keyCode == 13 && ! event.shiftKey) {
			$(this.form).submit()
			return false;
		 }
	});
	
	/***gestion des cookies***/
	
	function createCookie(name,value,days) {
		if(ses == null){
			if (days) {
				var date = new Date();
				date.setTime(date.getTime()+(days*24*60*60*1000));
				var expires = "; expires="+date.toGMTString();
			}
			else var expires = "";
			document.cookie = name+"="+value+expires+"; path=/";
		}else{
			var date = new Date();
			if (days) {
				date.setTime(date.getTime()+(days*24*60*60*1000));
			}
			ses.cookies.set({
				url: "/", //the url of the cookie.
				name: name, // a name to identify it.
				value: value, // the value that you want to save
				expirationDate: date.getTime()
			}, function(error) {
				if(error!=null)console.log(error);
			});
		}
	}

	function readCookie(name) {
		var nameEQ = name + "=";
		var ca = document.cookie.split(';');
		for(var i=0;i < ca.length;i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') c = c.substring(1,c.length);
			if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
		}
		return null;
	}

	function eraseCookie(name) {
		//if(ses == null){
			createCookie(name,"",-1);
		/*}else{
			ses.cookies.remove('/', name, function (data) {
				console.log(data);
			});
		}*/
	}
	
	if(ses == null){
		pseudo = readCookie("pseudo");
		url = readCookie("image");
		style = readCookie("style");
		fluid = readCookie("fluid") == "true";
		
		handlePromptAndCookies();
	}else{
		ses.cookies.get({name: "pseudo"}, function(error, cookies) {
			pseudo = ((cookies.length > 0 && cookies[0].value != "") ? cookies[0].value : null );
			
			ses.cookies.get({name: "image"}, function(error, cookies) {
				url = ((cookies.length > 0 && cookies[0].value != "") ? cookies[0].value : null );
				
				ses.cookies.get({name: "style"}, function(error, cookies) {
					style = ((cookies.length > 0 && cookies[0].value != "") ? cookies[0].value : null );
					
					ses.cookies.get({name: "fluid"}, function(error, cookies) {
						fluid = (cookies.length > 0 ? cookies[0].value == "true" : false );
						
						handlePromptAndCookies();
					});
				});
			});
		});
	}
	
	/*** Fin cookie ***/

	async function handlePromptAndCookies(){
		/*console.log(pseudo);
		console.log(url);
		console.log(style);
		console.log(fluid);*/
	
		if(style != null) 
			$('link[id="link"]').attr('href','css/'+style+'.css');
		$("#all").attr('class', 'container'+((fluid)?("-fluid"):("")));
		
		if(pseudo == null || url == null){
			if(electron == null){
				// On demande le pseudo		
				pseudo = prompt('Quel est votre pseudo ?');
				
				//on demande le liens image
				url = prompt('URL d\'une image :');
			}else{
				// Module to create native browser window.
				const BrowserWindow = electron.BrowserWindow;
				const prompt = require('electron-prompt');
				
				//var prompter = require('prompt-sync')();
				//var n = prompter('How many more times? ');
				// On demande le pseudo		
				await prompt({
					title: 'Choisissez votre pseudo',
					label: 'Pseudo :'
				}, BrowserWindow)
				.then((r) => {
					if(r === null) {
						pseudo = null;
					} else {
						pseudo = r;
					}
				})
				.catch(console.error);		
				
				//on demande le liens image
				//url = prompt('URL d\'une image :');
				await prompt({
					title: 'Choisissez votre image',
					label: 'URL :'
				})
				.then((r) => {
					if(r === null) {
						url = null;
					} else {
						url = r;
					}
				})
				.catch(console.error);	
			}
			
			if(!pseudo)pseudo="Unknow";
				
			if(!url)url="https://yt3.ggpht.com/-uGYJvczbuow/AAAAAAAAAAI/AAAAAAAAAAA/VQbgt1FitYs/s900-c-k-no-mo-rj-c0xffffff/photo.jpg"
			
			//on créer les cookies
			createCookie("style","styleNorm",356);
			createCookie("pseudo",pseudo,356);
			createCookie("image",url,356);
		}
		
		handleAllSocket();
	}
	
	function handleAllSocket(){
		document.getElementById('allDiv').className = "";
		
		socket = io.connect(ip, {
			reconnection: true,
			reconnectionDelay: 1000,
			reconnectionDelayMax : 5000,
			reconnectionAttempts: Infinity
		} );
		
		socket.on( 'connect', function () {
			//console.log( 'connected to server' );
			//on reset la page car le client va tout recevoir a nouveau !
			$('#zone_chat').text('');
			$('#zone_util').text('');
			$('#combo').text('');
			$('#combo').append('<option value="Tous">Tous</option>');
			//on l'envoie au serveur et on l'affiche dans le titre
			socket.emit('nouveau_client', pseudo,url);
			document.title = pseudo + ' - ' + document.title;
			$('#pseudo').text(pseudo);
			$('#avatar').attr('src',url);
			/** plus utile car se fait desormais en auto dans nouveau_client **/
			//socket.emit('clients');
			
		} );
		
		socket.on('bouton_test', function(info) {
			alert(info);
		});			
		
		socket.on( 'disconnect', function () {
			//console.log( 'disconnected from server' );
			/** plus utile : a gérer directement dans on.disconnect du serveur **/
			//socket.emit('client_ecrit_fin');
			//socket.emit('clientparti');
			//window.setTimeout( 'app.connect()', 5000 );
		} );
		
		socket.on('client_ecrit', function(pseudos) {
			//console.log(pseudos);
			$('#zone_client_ecrit').html('En train d\'écrire : ');
			for(var i=0; i<pseudos.length;i++){
				if(pseudos[i] != pseudo)
					$('#zone_client_ecrit').append(pseudos[i]+"... ");
			}
		});
		
		// Quand on reçoit un message, on l'insère dans la page
		socket.on('message', function(data) {
			insereMessage(data.pseudo, data.destinataire, data.message, data.type, data.date, data.debut, data.divers);
			if(document.body.className == 'blurred'){
				PageTitleNotification.Off();
				PageTitleNotification.On(data.pseudo + " a écrit un message");
			}
		});
		
		// Quand on flood
		socket.on('flood', function(delais) {
			alert("Veuillez cessez de flooder !\n\nVous devez désormais attendre "+delais+" secondes.");
		});
		
		// Quand un nouveau client se connecte, on affiche l'information
		socket.on('nouveau_client', function(pseudo,url, date) {
			$('#zone_chat').prepend('<div class="info">' + date + " : " + pseudo + ' a rejoint le Chat !</div>');
			appendClient(pseudo, url);
		});
		
		socket.on('clientparti', function(pseudo, date) {
			$('#zone_chat').prepend('<div class="info">' + date + " : " + pseudo + ' a quitté le Chat !</div>');	
			$('#zone_util'+pseudo).remove();
			$('#combo'+pseudo).remove();
			//$('#combo').text('');
			//$('#combo').prepend('<option value="Tous">Tous</option>');
			//socket.emit('clients');
		});
		
		socket.on('download', function(fileExist, fichier){
			if(fileExist){
				//block_beforeunload = true;
				window.location.href = ip+"/download/"+fichier;
			}else{
				alert("Le fichier n'existe plus sur le serveur.");
			}
		});
		
		socket.on('uploaded', function(nomFic) {
			alert(nomFic);
				var dest = $('#combo option:selected').val();
				socket.emit('message', nomFic, dest);
		});
		
		socket.on('harlem', function() {
				harlem();
		});
		
		socket.on('reset', function() {
			eraseCookie("style");
			eraseCookie("pseudo");
			eraseCookie("image");
			window.location.reload();
		});
		
		socket.on('clear', function() {
			ctx.clearRect(0, 0, 5000, 5000);
			ctx.beginPath();
		});
		
		socket.on('fluid', function() {
			fluid = !fluid;
			createCookie("fluid",fluid,356);
			$("#all").attr('class', 'container'+((fluid)?("-fluid"):("")));
		});
		
		socket.on('wizz', function() {
				var snd = new Audio(ip+"/audio/hey.mp3"); // buffers automatically when created
				snd.play();
				$( "#all" ).effect( "shake", {times:4, distance:50, direction:"left"}, 500  );
				//$( "#all" ).effect( "shake", {times:4, distance:50, direction:"up"}, 500  );
				//$( "#all" ).effect( "shake", {times:2, distance:50, direction:"left"}, 500  );
		});
		
		socket.on('effacerToutLesFichiers', function() {
			alert("Tout les fichiers précédement envoyés ont été supprimés !");
		});
		
		socket.on('affiche_plus_fin', function() {
			$(window).data('ajaxready', true);			
			$('#zone_chat #loader').fadeOut(400);		
		});
		
		socket.on('affiche_plus_fin_gif', function() {
			$('#zone_chat #loader').fadeOut(400);		
		});
		
		infiniteScroll();
		
		//fctCanvas();
		
		var canvas = $('#paper');
		var	ctx = canvas[0].getContext('2d');
		
		$(function(){
		//function fctCanvas(){
			// This demo depends on the canvas element
			if(!('getContext' in document.createElement('canvas'))){
				alert('Sorry, it looks like your browser does not support canvas!');
				return false;
			}

			var doc = $(document),
				win = $(window);
								
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			//ctx.scale(canvas.width,canvas.width);

			// Generate an unique ID
			var id = Math.round($.now()*Math.random());

			// A flag for drawing activity
			var drawing = false;

			var clients = {};
			var cursors = {};
			//var rect = canvas.getBoundingClientRect();
			socket.on('moving', function (data) {

				if(! (data.id in clients)){
					// a new user has come online. create a cursor for them
					cursors[data.id] = $('<div class="cursor">').appendTo('#cursors');
				}

				// Move the mouse pointer
				cursors[data.id].css({
					'left' : data.x,
					'top' : data.y
				});

				// Is the user drawing?
				if(data.drawing && clients[data.id]){

					// Draw a line on the canvas. clients[data.id] holds
					// the previous position of this user's mouse pointer

					//drawLine(clients[data.id].x, clients[data.id].y, data.x, data.y, data.color);
					drawLine(data.x_prec, data.y_prec, data.x, data.y, data.color);
				}

				// Saving the current client state
				clients[data.id] = data;
				clients[data.id].updated = $.now();
			});

			var prev = {};

			canvas.on('mousedown',function(e){
				e.preventDefault();
				drawing = true;
				prev.x = e.pageX ;
				prev.y = e.pageY ;
				
				// Hide the instructions
				//instructions.fadeOut();
			});

			doc.bind('mouseup mouseleave',function(){
				drawing = false;
			});

			var lastEmit = $.now();

			doc.on('mousemove',function(e){
				if($.now() - lastEmit > 5 && drawing){
					var dest = $('#combo option:selected').val();
					socket.emit('mousemove',{
						'x': e.pageX,
						'y': e.pageY,
						'x_prec': prev.x,
						'y_prec': prev.y,
						'drawing': drawing,
						'id': id,
						'color':$(".titre").css("color")
					},dest);
					lastEmit = $.now();
				}

				// Draw a line for the current user's movement, as it is
				// not received in the socket.on('moving') event above

				if(drawing){
					
					drawLine(prev.x, prev.y, e.pageX, e.pageY, $(".titre").css("color"));

					prev.x = e.pageX;
					prev.y = e.pageY;
				}
			});

			// Remove inactive clients after 10 seconds of inactivity
			setInterval(function(){

				for(ident in clients){
					if($.now() - clients[ident].updated > 10000){

						// Last update was more than 10 seconds ago.
						// This user has probably closed the page

						cursors[ident].remove();
						delete clients[ident];
						delete cursors[ident];
					}
				}

			},10000);
			function drawLine(fromx, fromy, tox, toy, color){
				ctx.beginPath();
				/*ctx.moveTo(fromx-canvas.offset().left, fromy-canvas.offset().top);
				ctx.lineTo(tox-canvas.offset().left, toy-canvas.offset().top);*/
				//ctx.moveTo(-canvas.offset().left, -canvas.offset().top);
				ctx.moveTo(fromx, fromy);
				ctx.lineTo(tox, toy);
				ctx.strokeStyle = color;
				ctx.lineWidth = 1;
				ctx.stroke();
			}
		});
	}
	
	
	function keyupORchange() {
		var message = $('#message').val();
		//console.log(message);
		if(message!=""){
			socket.emit('client_ecrit');
		}else{
			socket.emit('client_ecrit_fin');
		}
	}
	
	$('#message').change(function(event) {
		keyupORchange();
	});
	
	$('#message').keyup(function(event) {
		keyupORchange();
	});
	
	$('#bouton_test').click(function(event) {
		<!-- var message = $('#message').val(); -->
		<!-- alert(message.slice(0, $('#message').selectionStart).length); -->
		<!-- var $txt = jQuery("#message"); -->
		<!-- var caretPos = $txt[0].selectionStart; -->
		<!-- var textAreaTxt = $txt.val(); -->
		<!-- var txtToAdd = "stuff"; -->
		<!-- $txt.val(textAreaTxt.substring(0, caretPos) + txtToAdd + textAreaTxt.substring(caretPos) ); -->
		socket.emit('bouton_test');
	});
	


	//fonction pour informer par clignottement du titre
	var PageTitleNotification = {
		Vars:{
			OriginalTitle: document.title,
			Interval: null
		},    
		On: function(notification, intervalSpeed){
			var snd = new Audio("audio/newmessage.mp3"); // buffers automatically when created
			snd.play();
			var _this = this;
			_this.Vars.Interval = setInterval(function(){
				 document.title = (_this.Vars.OriginalTitle == document.title)
									 ? notification
									 : _this.Vars.OriginalTitle;
			}, (intervalSpeed) ? intervalSpeed : 1000);
		},
		Off: function(){
			clearInterval(this.Vars.Interval);
			document.title = this.Vars.OriginalTitle;   
		}
	}
	


	//fonction pour arreter clignotement
	function onBlur() {
		document.body.className = 'blurred';
	};
	function onFocus(){
		document.body.className = 'focused';
		PageTitleNotification.Off();
	};

	if (/*@cc_on!@*/false) { // check for Internet Explorer
		document.onfocusin = onFocus;
		document.onfocusout = onBlur;
	} else {
		window.onfocus = onFocus;
		window.onblur = onBlur;
	}
	
	function clicClient(pseudo) {
		//alert(pseudo);
		$('#combo option[value="' + pseudo + '"]').prop('selected', true);
		//$('#combo').value=pseudo;
	}
	
						
	function appendClient(pseudo, url){
		$('#zone_util').append('<div class="col-12 col-sm-6 col-md-12"><div class="clicClient boutonHover row" id="zone_util' + pseudo + '" onclick="clicClient(\'' + pseudo + '\')"><div class="col-4"><img class="avatarMini" src="'+url+'"></div><div class="pseudoMini col-8">'+ pseudo + '</div></div></div>');
		$('#combo').append('<option id="combo' + pseudo + '" value="' + pseudo + '">' + pseudo + '</option>');
	}
						
	/** plus utilisé : les clients déja la sont désomrais aussi recu par nouveau_client **/
	//on recoit les client deja la
	/*socket.on('clients', function(pseudo,url) {
		appendClient(pseudo, url);
	});*/
	
	

	// Lorsqu'on envoie le formulaire, on transmet le message et on l'affiche sur la page
	$('#formulaire_chat').submit(function () {
		var message = $('#message').val();
		var dest = $('#combo option:selected').val();
		if(message != ""){
			socket.emit('message', message, dest); // Transmet le message aux autres
			//insereMessage(pseudo, message); // Affiche le message aussi sur notre page
			$('#message').val('').focus(); // Vide la zone de Chat et remet le focus dessus
		}
		return false; // Permet de bloquer l'envoi "classique" du formulaire
	});
	
	/** Plus utilisé car gérer via deconnection du socket **/
	/*$(window).on('beforeunload',function () {
		if(block_beforeunload){
			block_beforeunload = false;
			return;
		}
		socket.emit('client_ecrit_fin');
		socket.emit('clientparti');
		//return "Bye now!";
	});*/
	
	function convert(text)
    {
	  var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
	  var text1=text.replace(exp, "<a href='$1' target='_blank'>$1</a>");
	  //console.log(text1);
	  var exp2 =/(^|[^\/])(www\.[\S]+(\b|$))/gim;
	  return text1.replace(exp2, '$1<a target="_blank" href="http://$2">$2</a>');
    }
	
	function on(img) {
		$('#imageOverlay').attr('src', img.src);
		document.getElementById("overlay").style.display = "flex";
	}

	function off() {
		document.getElementById("overlay").style.display = "none";
	}
	
	// Ajoute un message dans la page
	function insereMessage(pseudo, destinataire, message, type, date, debut, divers) {
		var classAstuces = "";
		var classBigPic = "";
		var showEmote = true;
		if(type != "/"){
			if(message.includes('&colon;ascii&colon;')){
				message = message.replace('&colon;ascii&colon;&NewLine;','');
				message = message.replace('&colon;ascii&colon;','');
				classAstuces += " mono mini";
				showEmote = false;
			}
			if(message.includes('&colon;mono&colon;')){
				message = message.replace('&colon;mono&colon;&NewLine;','');
				message = message.replace('&colon;mono&colon;','');
				classAstuces += " mono";
			}
			if(message.includes('&colon;mini&colon;')){
				message = message.replace('&colon;mini&colon;&NewLine;','');
				message = message.replace('&colon;mini&colon;','');
				classAstuces += " mini";
			}
			if(message.includes('&colon;micro&colon;')){
				message = message.replace('&colon;micro&colon;&NewLine;','');
				message = message.replace('&colon;micro&colon;','');
				classAstuces += " micro";
			}
			if(message.includes('&colon;maxi&colon;')){
				message = message.replace('&colon;maxi&colon;&NewLine;','');
				message = message.replace('&colon;maxi&colon;','');
				classAstuces += " maxi";
			}
			if(message.includes('&colon;noemote&colon;')){
				message = message.replace('&colon;noemote&colon;&NewLine;','');
				message = message.replace('&colon;noemote&colon;','');
				showEmote = false;
			}
			if(message.includes('&colon;bigpic&colon;')){
				message = message.replace('&colon;bigpic&colon;&NewLine;','');
				message = message.replace('&colon;bigpic&colon;','');
				classBigPic += " bigPic";
			}
			if(type == "fichier"){
				showEmote = false;
			}
		}
		if(showEmote){
			message = message.replace(/&colon;mlm&colon;/g, '<img src="emote/fuck.png" title=":mlm:"/>');
			message = message.replace(/&colon;MLM&colon;/g, '<img src="emote/fuck.gif" title=":MLM:"/>');
			message = message.replace(/&colon;cafe&colon;/g, '<img src="emote/cafe.png" title=":cafe:"/>');
			message = message.replace(/&colon;CAFE&colon;/g, '<img src="emote/cafeBig.png" title=":CAFE:"/>');
			message = message.replace(/&colon;poop&colon;/g, '<img src="emote/poop.png" title=":poop:"/>');
			message = message.replace(/&colon;POOP&colon;/g, '<img src="emote/poopBig.png" title=":POOP:"/>');
			message = message.replace(/&colon;&rpar;/gi, '<img src="emote/Smile.png" title=":)"/>');
			message = message.replace(/&lt;3/gi, '<img src="emote/Heart.png" title="<3"/>');
			message = message.replace(/&semi;&rpar;/gi, '<img src="emote/Wink.png" title=";)"/>');
			message = message.replace(/&colon;s/gi, '<img src="emote/Confused.png" title=":s"/>');
			message = message.replace(/&colon;d|xd/gi, '<img src="emote/Laughing.png" title=":d"/>');
			message = message.replace(/&colon;&lpar;/gi, '<img src="emote/Frown.png" title=":("/>');
			message = message.replace(/&Hat;&Hat;/gi, '<img src="emote/Grin.png" title="^^"/>');
			message = message.replace(/&colon;o/gi, '<img src="emote/Gasp.png" title=":o"/>');
			message = message.replace(/&colon;p/gi, '<img src="emote/Yuck.png" title=":p"/>');
		}
		if(type == "/"){
			if(debut){
				$('#zone_chat').prepend('<div class="info mono mini">'+ date + " : " + message + '</div>');
			}else{
				$('#zone_chat').append('<div class="info mono mini">'+ date + " : " + message + '</div>');
			}
		}else {
			pseudo = '<span class="titre emetteur bord">' + pseudo + '</span>';
			var vers = '<span class="vers fas fa-arrow-right bord"></span>';
			if(destinataire=="Tous"){
				destinataire = '<span class="titre destinataire destTous">' + destinataire + '</span>';
			}
			else{
				destinataire = '<span class="titre destinataire bord">' + destinataire + '</span>';
			}
			date = '<span class="date">' + date + '</span>';
			//console.log(type);
			if(type == "fichier"){
				//console.log(message+"\n\n"+divers);
				//si type fichier, split les noms de fichier et les afficher en hyperlien pour clic download
				var mess = "";
				var ficList;
				if(message.includes('&colon;file&colon;')){
					var messFic = message.split('&colon;file&colon;');
					var mess = messFic[0];
					ficList = messFic[1].split('&VerticalLine;');
				}else{
					ficList = message.split('&VerticalLine;');
				}
				//de plus, split divers qui contient, pour cuaque fichier, l'info de le barrer ou non (barrer su fichier delete)
				var divList = divers.split('&VerticalLine;');
				message = "";
				if (mess != "") {
					message += mess + "\n";
				}
				var i=0;
				ficList.forEach(function(element) {
					message += '<div class="divFichier backColorTransp" style="display:inline-block;">';
					//console.log(element + " == " + divList[i]);
					if(divList[i] != "barrer" && (element.toLowerCase().endsWith('.jpg') || element.toLowerCase().endsWith('&period;jpg')
						|| element.toLowerCase().endsWith('.png') || element.toLowerCase().endsWith('&period;png') 
						|| element.toLowerCase().endsWith('.gif') || element.toLowerCase().endsWith('&period;gif')
						|| element.toLowerCase().endsWith('.bmp') || element.toLowerCase().endsWith('&period;bmp')
						|| element.toLowerCase().endsWith('.ico') || element.toLowerCase().endsWith('&period;ico')))
					{
						var src = ip + '/uploads/' + element;
						
						message += '<img onclick="on(this)" class="imgFichier imageHover '+classBigPic+'" src="' + src + '">';
					}//<a href="' + ip + '/uploads/' + element + '" target="_blank"></a>
					message += '<span id="span" class="fichier boutonHover ' + divList[i++] + '" onclick="downloadFichier(\'' + element + '\')">'
					message += '<i class="fas fa-download fichierIcon"></i>' + element + '</span>';//<a href="' + url + '" download></a>
					message += '</div>';
				});
			}else{
				var txt = document.createElement("textarea");
				txt.innerHTML = message;
				message = txt.value;
				message = convert(message);
			}
			var messageTotal = '<div class="messageTotal backColorTransp"><div class="enteteMessage"><span class="emetVersDest">' + pseudo + vers + destinataire + '</span>' + date + '</div><div class="message '+classAstuces+'">' + message + '</div></div>';
			if(debut){
				$('#zone_chat').prepend(messageTotal);
			}else{
				$('#zone_chat').append(messageTotal);
			}
		}
		$('#canv').height($('#gauche').outerHeight(true)+50);
	}
	
	
/****** code for download  *******/	
	//var $idown;  // Keep it outside of the function, so it's initialized once.
	function downloadFichier(fichier){
		//alert(fichier);
		<!-- var aItem = $(event).find('a').first(); -->
		<!-- var aHref = aItem.attr('href'); -->
		socket.emit('download',fichier);
		//document.getElementById('my_iframe').src = ip+"/uploads/"+fichier;
		/*var url = ip+"/uploads/"+fichier;
		if ($idown) {
			$idown.attr('src',url);
		} else {
			$idown = $('<iframe>', { id:'idown', src:url }).hide().appendTo('body');
		}*/
		//aItem.click();
	}
	
	//variable pour empecher le navigateur de croire que le client part quand il DL un fichier
	//var block_beforeunload = false;
	
	
/****** code for upload  *******/
	$('.upload-btn').on('click', function (){
		$('#upload-input').click();
		$('.progress-bar').text('0%');
		$('.progress-bar').width('0%');
	});

	$('#upload-input').on('change', function(){
		
		console.log("wtf");
	  var files = $(this).get(0).files;

	  
	  handleUpload(files);
	  
	});
/****** drag and drop ******/
	var isAdvancedUpload = function() {
		var div = document.createElement('div');
		return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
	}();

	if (isAdvancedUpload) {

	  var droppedFiles = false;

	  var $form = $('#allDiv');
	  
	  $form.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
		e.preventDefault();
		e.stopPropagation();
	  })
	  .on('dragover dragenter', function() {
		$form.addClass('is-dragover');
	  })
	  .on('dragleave dragend drop', function() {
		$form.removeClass('is-dragover');
	  })
	  .on('drop', function(e) {
		droppedFiles = e.originalEvent.dataTransfer.files;
		//$form.trigger('submit');
		handleUpload(droppedFiles);
	  });

	}
	
	function handleUpload(files){
		if (files.length > 0){
		// create a FormData object which will be sent as the data payload in the
		// AJAX request
		var formData = new FormData();

		// loop through all the selected files and add them to the formData object
		for (var i = 0; i < files.length; i++) {
		  var file = files[i];

		  // add the files to formData object for the data payload
		  formData.append('uploads[]', file, file.name);
		}

		$.ajax({
		  url: ip+'/upload',
		  type: 'POST',
		  data: formData,
		  processData: false,
		  contentType: false,
		  success: function(data){
			  console.log('upload successful!\n n:' + data);
			  var dest = $('#combo option:selected').val();
			  var message = $('#message').val();
			  $('#message').val('').focus(); // Vide la zone de Chat et remet le focus dessus
			  
			  socket.emit('uploaded', data, message, dest);
		  },
		  xhr: function() {
			// create an XMLHttpRequest
			var xhr = new XMLHttpRequest();

			// listen to the 'progress' event
			xhr.upload.addEventListener('progress', function(evt) {

			  if (evt.lengthComputable) {
				// calculate the percentage of upload completed
				var percentComplete = evt.loaded / evt.total;
				percentComplete = parseInt(percentComplete * 100);

				// update the Bootstrap progress bar with the new percentage
				$('.progress-bar').text(percentComplete + '%');
				$('.progress-bar').width(percentComplete + '%');

				// once the upload reaches 100%, set the progress bar text to done
				if (percentComplete === 100) {
				  $('.progress-bar').html('Terminé');
				}

			  }

			}, false);

			return xhr;
		  }
		});

	  }
	}
	
	function harlem() 
	{ 
	  javascript:(function(){function c(){var e=document.createElement("link");e.setAttribute("type","text/css");e.setAttribute("rel","stylesheet");
	  e.setAttribute("href",f);e.setAttribute("class",l);document.body.appendChild(e)}function h(){var e=document.getElementsByClassName(l);for(var t=0;
	  t<e.length;t++){document.body.removeChild(e[t])}}function p(){var e=document.createElement("div");e.setAttribute("class",a);document.body.appendChild(e);
	  setTimeout(function(){document.body.removeChild(e)},100)}function d(e){return{height:e.offsetHeight,width:e.offsetWidth}}function v(i){var s=d(i);
	  return s.height>e&&s.height<n&&s.width>t&&s.width<r}function m(e){var t=e;var n=0;while(!!t){n+=t.offsetTop;t=t.offsetParent}return n}
	  function g(){var e=document.documentElement;if(!!window.innerWidth){return window.innerHeight}else if(e&&!isNaN(e.clientHeight)){return e.clientHeight}
	  return 0}function y(){if(window.pageYOffset){return window.pageYOffset}return Math.max(document.documentElement.scrollTop,document.body.scrollTop)}
	  function E(e){var t=m(e);return t>=w&&t<=b+w}function S(){var e=document.createElement("audio");e.setAttribute("class",l);e.src=i;e.loop=false;
	  e.addEventListener("canplay",function(){setTimeout(function(){x(k)},500);setTimeout(function(){N();p();for(var e=0;e<O.length;e++){T(O[e])}},15500)},true);
	  e.addEventListener("ended",function(){N();h()},true);e.innerHTML=" <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
	  document.body.appendChild(e);e.play()}function x(e){e.className+=" "+s+" "+o}function T(e){e.className+=" "+s+" "+u[Math.floor(Math.random()*u.length)]}
	  function N(){var e=document.getElementsByClassName(s);var t=new RegExp("\\b"+s+"\\b");for(var n=0;n<e.length;){e[n].className=e[n].className.replace(t,"")}}var e=30;
	  var t=30;var n=350;var r=350;var i="http://s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";var s="mw-harlem_shake_me";var o="im_first";
	  var u=["im_drunk","im_baked","im_trippin","im_blown"];var a="mw-strobe_light";var f="http://s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
	  var l="mw_added_css";var b=g();var w=y();var C=document.getElementsByTagName("*");var k=null;for(var L=0;L<C.length;L++){var A=C[L];if(v(A)){if(E(A)){k=A;break}}}
	  if(A===null){console.warn("Could not find a node of the right size. Please try a different page.");return}c();S();var O=[];for(var L=0;L<C.length;L++){var A=C[L];
	  if(v(A)){O.push(A)}}})()
	}
	

	function infiniteScroll(){
		var offset = 1;

		// on initialise ajaxready à true au premier chargement de la fonction
		$(window).data('ajaxready', true);

		$('#zone_chat').append('<div id="loader"><center><img src="https://loading.io/spinners/microsoft/lg.rotating-balls-spinner.gif" alt="loader ajax"></center></div>');
		
		$('#zone_chat #loader').fadeOut(400);	
		$('#top').fadeOut(10);
		
		var deviceAgent = navigator.userAgent.toLowerCase();
		var agentID = deviceAgent.match(/(iphone|ipod|ipad)/);

		$(window).scroll(function() {
			//affiche ou masque div #top
			if($(window).scrollTop()==0){
				$('#top').fadeOut(1000);
			}
			else{
				$('#top').fadeIn(1000);
			}
			
			// On teste si ajaxready vaut false, auquel cas on stoppe la fonction
			if ($(window).data('ajaxready') == false) return;
				
			//alert($(window).scrollTop() + $(window).height() + "||" + $(document).height() + "||||" + (($(window).scrollTop() + $(window).height()) + 150) + "||" + $(document).height());
			
			if(($(window).scrollTop() + $(window).height()) + 50 >= $(document).height()
			|| agentID && ($(window).scrollTop() + $(window).height()) + 150 >= $(document).height()) {
				// lorsqu'on commence un traitement, on met ajaxready à false
				$(window).data('ajaxready', false);

				$('#zone_chat #loader').remove();
				$('#zone_chat').append('<div id="loader"><center><img src="https://loading.io/spinners/microsoft/lg.rotating-balls-spinner.gif" alt="loader ajax"></center></div>');
				$('#zone_chat #loader').fadeIn(400);

				socket.emit('affiche_plus', offset);
				offset++;
			}
		});
	};
	
	
//}

//global();
        </script>
    </body>
</html>